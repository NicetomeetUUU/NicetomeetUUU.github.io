---
title: "ros-srv通信"
date: 2024-01-08
description: "用于修改采集环境，同步采集结果到客户端"
type: "post"
tags: ["blog","ros相关"]
---

# ROS-srv服务编写

Person: COO Ni

# 本篇记录ros-srv服务实现

## 1. 在ros-package下创建srv通信格式

- 修改package.xml

```xml
<!--添加编译生成服务消息包与运行加载服务消息包-->
<build_depend>message_generation</build_depend>
<exec_depend>message_runtime</exec_depend>
```

- 自定义CMakeLists.txt

```cpp

find_package(catkin REQUIRED COMPONENTS
  roscpp
  rospy
  std_msgs
  geometry_msgs     //用到哪个包就要放进来哪个包
  message_generation //把message_generation放到cmake文件中, 编译消息类型
  //不用放runtime, 因为它在运行过程中生效
)

generate_messages(
  DEPENDENCIES
  std_msgs
  geometry_msgs
) //这里要声明选用的消息格式, 由于我用到pose和bool所以加上geometry_msgs
```

- 自定义srv服务消息格式:
    - 我这里新建了一个call_for_move.srv文件
        - - - -用于分割请求部分与响应部分, 这里想发目标位姿, 返回是否正确执行；
        
        ```cpp
        geometry_msgs/Pose pose
        ---
        std_msgs/Bool success
        ```
        
    - 在CMakeList.txt文件下声明此消息类型:
        
        ```cpp
        add_service_files(
          FILES
          call_for_move.srv
        )
        ```
        
    - 编译工作区, 并使用rossrv show name.srv查看类型:
        
        ```bash
        rossrv show call_for_move.srv
        [gazebo_tactile_data_simulator/call_for_move]:
        geometry_msgs/Pose pose
          geometry_msgs/Point position
            float64 x
            float64 y
            float64 z
          geometry_msgs/Quaternion orientation
            float64 x
            float64 y
            float64 z
            float64 w
        ---
        std_msgs/Bool success
          bool data
        ```
        

## 2. srv消息使用测试:

- 服务端设定:
    - test_srv.py
        
        ```python
        #! /usr/bin/env python3
        
        import rospy
        from gazebo_tactile_data_simulator.srv import call_for_move, call_for_moveResponse, call_for_moveRequest
        from std_msgs.msg import Bool
        
        def handlle_move_request(req):
            rospy.loginfo('Request for moving to %s', req.pose)
            rospy.sleep(2)
            res = call_for_moveResponse()
            res.success = Bool(data=True) #这里注意要使用std_msgs下的bool类传递值
            return res
        
        def main():
            rospy.init_node('test_srv', log_level=rospy.INFO)
            rospy.Service('call_for_move', call_for_move, handlle_move_request)
            rospy.spin()
        
        if __name__ == "__main__":
            main()
        
        ```
        
    - test_client.py
        
        ```python
        #! /usr/bin/env python3
        
        import rospy
        from gazebo_tactile_data_simulator.srv import *
        from geometry_msgs.msg import Pose, Quaternion, Point32
        from std_msgs.msg import Bool
        
        def move_request(req):
            rospy.wait_for_service('call_for_move')
            try:
                service_proxy = rospy.ServiceProxy('call_for_move', call_for_move)
                res = service_proxy(req)
                print('res is:', res)
                return res
            except rospy.ServiceException as e:
                print('Service call failed: ', e)
        
        def main():
            rospy.init_node("test_client", log_level=rospy.INFO)
            pose = Pose()
            pose.position = Point32(x=0.7, y=0.17, z=0.676)
            pose.orientation = Quaternion(x=0.0, y=0.0, z=0.0, w=0.0)
            req = call_for_moveRequest()
            req.pose = pose
            res = move_request(req)
            print("res is:", res)
        
        if __name__ == "__main__":
            main()
        ```